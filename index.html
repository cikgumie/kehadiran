<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kehadiran Murid</title>
    <style>
        :root {
            --primary-color: #4a90e2; --primary-hover-color: #357abd; --success-color: #34a853;
            --error-color: #ea4335; --warning-color: #fbbc05; --light-bg-color: #f8f9fa;
            --white-color: #ffffff; --text-color: #3c4043; --border-color: #dadce0;
            --shadow-color: rgba(60, 64, 67, 0.15);
            --font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }
        body { font-family: var(--font-family); background-color: var(--light-bg-color); color: var(--text-color); margin: 0; padding: 16px; line-height: 1.6; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .container { width: 100%; max-width: 900px; background-color: var(--white-color); padding: 24px; border-radius: 16px; box-shadow: 0 4px 20px var(--shadow-color); border: 1px solid var(--border-color); }
        .navigation { display: flex; flex-wrap: wrap; gap: 10px; border-bottom: 1px solid var(--border-color); margin-bottom: 25px; }
        .nav-btn { padding: 10px 16px; border: none; background-color: transparent; cursor: pointer; font-size: 1em; font-weight: 600; color: #5f6368; border-bottom: 3px solid transparent; transition: color 0.2s, border-color 0.2s; }
        .nav-btn:hover { color: var(--primary-color); }
        .nav-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .view { display: none; }
        .view.active { display: block; }
        header h1 { margin: 0; color: var(--primary-color); font-size: 1.8em; font-weight: 600; text-align: center; }
        header p { margin: 8px 0 25px; color: #5f6368; font-size: 1em; text-align: center; }
        .controls { display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: flex-end; margin-bottom: 30px; }
        .control-group { display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: 8px; font-size: 0.9em; color: #202124; }
        select, input[type="date"], input[type="text"] { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; font-size: 1em; font-family: var(--font-family); transition: border-color 0.2s, box-shadow 0.2s; }
        button { background-color: var(--primary-color); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1em; font-weight: 600; transition: background-color 0.2s, transform 0.1s; }
        button:hover { background-color: var(--primary-hover-color); transform: translateY(-1px); }
        button:disabled { background-color: #cccccc; cursor: not-allowed; transform: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 14px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .message { padding: 16px; margin-top: 20px; border-radius: 8px; display: none; text-align: center; font-weight: 500; }
        .loader { text-align: center; padding: 50px; color: #5f6368; font-size: 1.1em; }
        .class-group { margin-bottom: 30px; }
        .class-group h2 { font-size: 1.4em; color: var(--text-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 8px; margin-bottom: 20px; }
        .class-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
        .class-card-button { background-color: var(--white-color); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; text-align: left; cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden; }
        .class-card-button:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.08); }
        .class-card-button h3 { margin: 0 0 5px; font-size: 1.2em; color: var(--text-color); }
        .class-card-button p { margin: 0; color: #5f6368; font-size: 0.9em; }
        .class-card-button .status-indicator { position: absolute; top: 15px; right: 15px; width: 20px; height: 20px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 12px; color: white; font-weight: bold; }
        .class-card-button.status-pending .status-indicator { background-color: var(--warning-color); }
        .class-card-button.status-completed .status-indicator { background-color: var(--success-color); }
        .class-card-button.status-completed .status-indicator::after { content: 'âœ“'; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal-content { background: var(--white-color); padding: 24px; border-radius: 16px; width: 90%; max-width: 700px; max-height: 90vh; position: relative; display: flex; flex-direction: column; }
        .modal-close-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 2em; cursor: pointer; color: #999; z-index: 101; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-right: 40px; }
        .modal-header h2 { margin: 0; flex-grow: 1; margin-right: 15px; font-size: 1.4em; }
        #modal-student-list { overflow-y: auto; flex-grow: 1; }
        .summary-section h2 { font-size: 1.4em; border-bottom: 2px solid var(--primary-color); padding-bottom: 8px; margin-bottom: 20px; }
        .stat-card { background: var(--light-bg-color); border-radius: 12px; padding: 20px; text-align: center; border: 1px solid var(--border-color); }
        .stat-card .value { font-size: 2.5em; font-weight: 700; }
        .stat-card .value.green { color: var(--success-color); } .stat-card .value.red { color: var(--error-color); }
        .overall-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; }
        .class-card { background: var(--white-color); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .class-card h3 { margin: 0 0 15px; font-size: 1.2em; }
        .class-card .details { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center; }
        #alerts-container ul { list-style-type: none; padding: 0; }
        #alerts-container li { background-color: #fef7e0; border-left: 5px solid var(--warning-color); padding: 16px 20px; margin-bottom: 12px; border-radius: 8px; }
        @media (max-width: 768px) { body { padding: 8px; } .container { padding: 16px; } .controls { grid-template-columns: 1fr; } .class-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); } .modal-content { padding: 16px; } .modal-header h2 { font-size: 1.2em; } }
    </style>
</head>
<body>
    <div class="container">
        <nav class="navigation">
            <button class="nav-btn active" data-view="attendance">Rekod Kehadiran</button>
            <button class="nav-btn" data-view="alerts">Lihat Amaran</button>
            <button class="nav-btn" data-view="summary">Rumusan</button>
        </nav>

        <div id="attendance-view" class="view active">
            <header><h1>Papan Pemuka Kehadiran</h1><p>Pilih tarikh, kemudian klik pada kelas untuk merekod kehadiran.</p></header>
            <main>
                <div class="controls"><div class="control-group"><label for="dashboard-date-picker">Pilih Tarikh:</label><input type="date" id="dashboard-date-picker"></div></div>
                <div id="class-dashboard"><div class="loader">Memuatkan kelas...</div></div>
            </main>
        </div>
        
        <!-- KOD HTML UNTUK ALERTS & SUMMARY DIKEMBALIKAN -->
        <div id="alerts-view" class="view">
            <header><h1>Amaran Ketidakhadiran Berturut-turut</h1><p>Senarai murid yang tidak hadir selama 3 hari atau lebih.</p></header>
            <main><div id="alerts-container"></div></main>
        </div>
        <div id="summary-view" class="view">
            <header><h1>Rumusan Kehadiran Harian</h1><p>Pilih tarikh untuk melihat analisis.</p></header>
            <main>
                <div class="controls"><div class="control-group"><label for="summary-date-picker">Pilih Tarikh:</label><input type="date" id="summary-date-picker"></div><button id="fetch-summary-btn">Papar Rumusan</button></div>
                <div id="summary-container"></div>
            </main>
        </div>

        <div id="message-box" class="message"></div>
    </div>

    <div id="attendance-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <div class="modal-header"><h2 id="modal-class-name"></h2></div>
            <div id="modal-student-list"></div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzvCuxEDxlHvgnrb9ef8Nzm3M1tji_ScF4e-jqm3lCB59sSlmTN_gxjzksDA-a3AORZtw/exec";

        const messageBox = document.getElementById('message-box');
        const navButtons = document.querySelectorAll('.nav-btn');
        const views = document.querySelectorAll('.view');
        const dashboardDatePicker = document.getElementById('dashboard-date-picker');
        const classDashboard = document.getElementById('class-dashboard');
        const alertsContainer = document.getElementById('alerts-container');
        const summaryDatePicker = document.getElementById('summary-date-picker');
        const fetchSummaryBtn = document.getElementById('fetch-summary-btn');
        const summaryContainer = document.getElementById('summary-container');
        const attendanceModal = document.getElementById('attendance-modal');
        const modalClassName = document.getElementById('modal-class-name');
        const modalStudentList = document.getElementById('modal-student-list');
        const modalCloseBtn = document.querySelector('.modal-close-btn');
        let currentClassId = null;

        function switchView(viewName) {
            views.forEach(v => v.classList.remove('active'));
            navButtons.forEach(b => b.classList.remove('active'));
            document.getElementById(`${viewName}-view`).classList.add('active');
            document.querySelector(`.nav-btn[data-view="${viewName}"]`).classList.add('active');
            if (viewName === 'attendance') loadClassDashboard();
            if (viewName === 'alerts') fetchAlerts();
            if (viewName === 'summary') fetchSummary(); // Panggilan fungsi dikembalikan
        }
        navButtons.forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));

        function showMessage(message, isError = false) { messageBox.textContent=message;messageBox.className=isError?'message error':'message success';messageBox.style.display='block';setTimeout(()=>messageBox.style.display='none',5000); }

        async function loadClassDashboard() {
            const selectedDate = dashboardDatePicker.value;
            if (!selectedDate) return;
            classDashboard.innerHTML = '<div class="loader">Menyemak status kelas...</div>';
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getClassesWithStatus&date=${selectedDate}`);
                const result = await response.json();
                if (result.success) { renderClassDashboard(result.data); } 
                else { throw new Error(result.message); }
            } catch (error) { showMessage(`Gagal memuatkan papan pemuka: ${error.message}`, true); classDashboard.innerHTML = '<p>Gagal memuatkan data.</p>'; }
        }

        function renderClassDashboard(groupedClasses) {
            if (Object.keys(groupedClasses).length === 0) { classDashboard.innerHTML = '<p>Tiada kelas ditemui.</p>'; return; }
            const groupOrder = ['Peralihan', 'Tahun 1', 'Tahun 2', 'Tahun 3', 'Tahun 4', 'Tahun 5', 'Tahun 6', 'Kelas Khas', 'Lain-lain'];
            let dashboardHTML = '';
            groupOrder.forEach(groupName => {
                if (groupedClasses[groupName]) {
                    dashboardHTML += `<div class="class-group"><h2>${groupName}</h2><div class="class-grid">`;
                    groupedClasses[groupName].forEach(cls => {
                        dashboardHTML += `<button class="class-card-button ${cls.hasRecord ? 'status-completed' : 'status-pending'}" data-class-id="${cls.classId}" data-class-name="${cls.className}"><div class="status-indicator"></div><h3>${cls.className}</h3><p>${cls.teacherName || 'Tiada Guru'}</p></button>`;
                    });
                    dashboardHTML += `</div></div>`;
                }
            });
            classDashboard.innerHTML = dashboardHTML;
            document.querySelectorAll('.class-card-button').forEach(card => card.addEventListener('click', (e) => { const target = e.currentTarget; openAttendanceModal(target.dataset.classId, target.dataset.className); }));
        }

        async function openAttendanceModal(classId, className) {
            currentClassId = classId;
            modalClassName.textContent = `Rekod Kehadiran: ${className}`;
            modalStudentList.innerHTML = '<div class="loader">Memuatkan senarai murid...</div>';
            attendanceModal.style.display = 'flex';
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getStudents&classId=${classId}`);
                const result = await response.json();
                if (result.success) { renderStudentTableInModal(result.data); } 
                else { throw new Error(result.message); }
            } catch (error) { showMessage(`Gagal memuatkan murid: ${error.message}`, true); modalStudentList.innerHTML = '<p>Gagal memuatkan data.</p>'; }
        }

        function renderStudentTableInModal(students) {
            const modalHeader = document.querySelector('#attendance-modal .modal-header');
            const oldBtn = modalHeader.querySelector('#submit-btn');
            if (oldBtn) oldBtn.remove();
            if (students.length === 0) { modalStudentList.innerHTML = '<p>Tiada murid ditemui.</p>'; return; }
            let tableHTML = `<p style="text-align:center; font-style:italic;">Tandakan hanya murid yang tidak hadir, lewat, atau bersebab.</p><form id="attendance-form"><table><thead><tr><th><input type="checkbox" id="check-all"></th><th>Nama Murid</th><th>Status</th><th>Catatan</th></tr></thead><tbody>`;
            students.forEach(student => { tableHTML += `<tr data-studentid="${student.studentId}"><td><input type="checkbox" class="student-checkbox"></td><td>${student.studentName}</td><td><select class="status-select" disabled><option value="Absent">Tidak Hadir</option><option value="Late">Lewat</option><option value="Excused">Bersebab</option></select></td><td><input type="text" class="remarks-input" placeholder="Cth: Demam" disabled></td></tr>`; });
            tableHTML += `</tbody></table></form>`;
            modalStudentList.innerHTML = tableHTML;
            const submitBtn = document.createElement('button');
            submitBtn.id = 'submit-btn';
            submitBtn.type = 'submit';
            submitBtn.setAttribute('form', 'attendance-form');
            submitBtn.textContent = 'Hantar Rekod';
            modalHeader.appendChild(submitBtn);
            document.querySelectorAll('.student-checkbox').forEach(cb => cb.addEventListener('change', (e) => { const row = e.target.closest('tr'); row.querySelectorAll('select, input[type="text"]').forEach(el => el.disabled = !e.target.checked); }));
            document.getElementById('check-all').addEventListener('change', (e) => { document.querySelectorAll('.student-checkbox').forEach(cb => { cb.checked = e.target.checked; cb.dispatchEvent(new Event('change')); }); });
            document.getElementById('attendance-form').addEventListener('submit', submitAttendance);
        }
        
        async function submitAttendance(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Menghantar...';
            const attendanceData = [];
            document.querySelectorAll('#attendance-form tbody tr').forEach(row => {
                if (row.querySelector('.student-checkbox').checked) {
                    attendanceData.push({ studentId: row.dataset.studentid, status: row.querySelector('.status-select').value, remarks: row.querySelector('.remarks-input').value });
                }
            });
            const payload = { date: dashboardDatePicker.value, classId: currentClassId, attendance: attendanceData };
            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', redirect: 'follow', body: JSON.stringify(payload), headers: { 'Content-Type': 'text/plain;charset=utf-8' } });
                showMessage("Permintaan hantar telah berjaya diproses.", false);
                attendanceModal.style.display = 'none';
                loadClassDashboard();
            } catch (error) { showMessage(`Gagal menghantar data: Terdapat isu rangkaian.`, true); }
        }

        // --- FUNGSI UNTUK ALERTS DAN SUMMARY DIKEMBALIKAN ---
        async function fetchAlerts() {
            alertsContainer.innerHTML='<div class="loader">Menyemak...</div>';
            try {
                const res = await fetch(`${SCRIPT_URL}?action=getConsecutiveAbsences`);
                const result = await res.json();
                if (result.success) { renderAlerts(result.data); }
                else { throw new Error(result.message); }
            } catch(e) { showMessage(`Gagal memuatkan amaran: ${e.message}`, true); alertsContainer.innerHTML=''; }
        }

        function renderAlerts(alerts) {
            if (alerts.length === 0) { alertsContainer.innerHTML='<p class="message success" style="display:block;">Tiada amaran ditemui.</p>'; return; }
            let listHTML = '<ul>';
            alerts.forEach(a => { listHTML += `<li><strong>${a.studentName}</strong> (ID: ${a.studentId})<br><small>Amaran pada: ${a.thirdAbsenceDate}</small></li>`; });
            listHTML += '</ul>';
            alertsContainer.innerHTML = listHTML;
        }

        async function fetchSummary() {
            const date = summaryDatePicker.value;
            if (!date) { showMessage("Sila pilih tarikh.", true); return; }
            summaryContainer.innerHTML = '<div class="loader">Menganalisis...</div>';
            try {
                const res = await fetch(`${SCRIPT_URL}?action=getSummary&date=${date}`);
                const result = await res.json();
                if (result.success) { renderSummary(result.data); }
                else { throw new Error(result.message); }
            } catch(e) { showMessage(`Gagal memuatkan rumusan: ${e.message}`, true); summaryContainer.innerHTML=''; }
        }

        function renderSummary(data) {
            const { overall, byClass } = data;
            let html = `<div class="summary-section"><h2>Rumusan Keseluruhan</h2><div class="overall-stats"><div class="stat-card"><div class="value">${overall.totalStudents}</div><div class="label">Jumlah Murid</div></div><div class="stat-card"><div class="value green">${overall.totalPresent}</div><div class="label">Hadir</div></div><div class="stat-card"><div class="value red">${overall.totalAbsent}</div><div class="label">Tidak Hadir</div></div><div class="stat-card"><div class="value green">${overall.percentage}</div><div class="label">Peratus Hadir</div></div></div></div><div class="summary-section"><h2>Pecahan Mengikut Kelas</h2><div class="class-grid">`;
            byClass.forEach(cls => {
                html += `<div class="class-card"><h3>${cls.className}</h3><div class="details"><div><div class="value">${cls.present}/${cls.totalStudents}</div><div class="label">Hadir</div></div><div><div class="value red">${cls.absent}</div><div class="label">Tidak Hadir</div></div></div><div class="stat-card" style="margin-top:15px;background-color:var(--white-color);"><div class="value green">${cls.percentage}</div><div class="label">Peratus Hadir</div></div></div>`;
            });
            html += '</div></div>';
            summaryContainer.innerHTML = html;
        }

        function initializeApp() {
            const today = new Date().toISOString().split('T')[0];
            dashboardDatePicker.value = today;
            summaryDatePicker.value = today;
            loadClassDashboard();
            dashboardDatePicker.addEventListener('change', loadClassDashboard);
            fetchSummaryBtn.addEventListener('click', fetchSummary); // Event listener dikembalikan
            modalCloseBtn.addEventListener('click', () => { attendanceModal.style.display = 'none'; });
            attendanceModal.addEventListener('click', (e) => { if (e.target === attendanceModal) { attendanceModal.style.display = 'none'; } });
        }
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
