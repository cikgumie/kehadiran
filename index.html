<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kehadiran Murid</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .view:not(.active) { display: none; }
        #modal-student-list { scrollbar-width: none; }
        #modal-student-list::-webkit-scrollbar { display: none; }
        .nav-btn { padding: 0.6rem 1rem; border-radius: 0.75rem; border: none; cursor: pointer; font-size: 0.95rem; transition: all 0.2s ease-in-out; -webkit-tap-highlight-color: transparent; }
        .pie-chart-text { font-size: 1.1rem; font-weight: 600; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container max-w-7xl mx-auto p-4 md:p-6 lg:p-8">
        
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 rounded-2xl mb-8 shadow-lg flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold">Selamat Datang ke Sistem e-Hadir</h2>
                <p class="opacity-80">Uruskan kehadiran murid dengan lebih cekap dan pantas.</p>
            </div>
            <div class="hidden md:block"><svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 21h8a2 2 0 0 0 2-2v-2H6v2a2 2 0 0 0 2 2Z"></path><path d="M16 17H8V5.1a2 2 0 0 1 2-2.1h4a2 2 0 0 1 2 2.1Z"></path><path d="M12 3V1"></path><path d="M12 21v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m4.93 19.07 1.41-1.41"></path><path d="m17.66 6.34 1.41-1.41"></path></svg></div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-6 md:p-8">
            
            <div class="flex flex-col sm:flex-row sm:items-center gap-4 mb-6">
                <div class="bg-indigo-600 text-white p-3 rounded-xl flex-shrink-0 w-14 h-14 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/><circle cx="12" cy="10" r="3"/></svg></div>
                <div><h1 class="text-2xl font-bold text-slate-900">Sistem Kehadiran Murid</h1><p class="text-slate-500" id="current-view-description">Pilih tarikh, kemudian klik pada kelas untuk merekod kehadiran.</p></div>
            </div>

            <nav class="mb-8 flex justify-center">
                <div class="inline-flex items-center bg-slate-100 p-1.5 rounded-xl space-x-1">
                    <button class="nav-btn active flex items-center gap-2" data-view="attendance" data-desc="Pilih tarikh, kemudian klik pada kelas untuk merekod kehadiran."><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg><span>Papan Pemuka</span></button>
                    <button class="nav-btn flex items-center gap-2" data-view="alerts" data-desc="Senarai amaran ketidakhadiran murid. Klik pada setiap amaran untuk mengambil tindakan."><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg><span>Amaran</span></button>
                    <button class="nav-btn flex items-center gap-2" data-view="summary" data-desc="Pilih tarikh untuk melihat analisis kehadiran harian."><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.05 17.24l.01 0c.1-1.24.9-2.34 2-2.73l4.08-1.45c.78-.28 1.64.1 1.91.88l1.45 4.08c.4 1.1.2 2.3-.5 3.1l0 0a2.94 2.94 0 0 1-4.1-1.19l-1.45-4.08a1.05 1.05 0 0 0-.9-.62L4.1 14.5c-1.1.1-2.1-.7-2.3-1.8l0 0a1.5 1.5 0 0 1 .25-.26z"></path><path d="M21.95 6.76l-.01 0c-.1-1.24-.9-2.34-2-2.73l-4.08-1.45c-.78-.28-1.64.1-1.91.88l-1.45 4.08c-.4 1.1-.2 2.3.5 3.1l0 0a2.94 2.94 0 0 0 4.1-1.19l1.45-4.08c.27-.78.1-1.64-.5-2.22l0 0c-.08-.08-.17-.16-.25-.24z"></path></svg><span>Rumusan</span></button>
                </div>
            </nav>

            <div id="attendance-view" class="view active"><main><div class="mb-8"><label for="dashboard-date-picker" class="block text-sm font-medium text-slate-700 mb-2">Pilih Tarikh:</label><input type="date" id="dashboard-date-picker" class="w-full max-w-xs p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></div><div id="class-dashboard"><div class="text-center p-12 text-slate-500">Memuatkan kelas...</div></div></main></div>
            <div id="alerts-view" class="view"><main><div class="mb-8"><label for="alert-class-filter" class="block text-sm font-medium text-slate-700 mb-2">Tapis Mengikut Kelas:</label><select id="alert-class-filter" class="w-full max-w-xs p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"><option value="all">Semua Kelas</option></select></div><div id="active-alerts-container" class="space-y-4"></div><div id="archived-alerts-container" class="mt-12"></div></main></div>
            <div id="summary-view" class="view"><main><div class="flex flex-col sm:flex-row items-end gap-4 mb-8"><div class="w-full sm:w-auto"><label for="summary-date-picker" class="block text-sm font-medium text-slate-700 mb-2">Pilih Tarikh:</label><input type="date" id="summary-date-picker" class="w-full max-w-xs p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></div><button id="fetch-summary-btn" class="w-full sm:w-auto bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2">Papar Rumusan</button></div><div id="summary-container"></div></main></div>
        </div>
    </div>

    <div id="attendance-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col"><div class="flex justify-between items-center p-5 border-b border-slate-200 flex-shrink-0"><h2 id="modal-class-name" class="text-xl font-bold text-slate-900"></h2><div class="flex items-center gap-4"><form id="attendance-form" class="contents"></form><button id="submit-btn-placeholder" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2" type="submit" form="attendance-form"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg><span>Hantar Rekod</span></button><button class="modal-close-btn bg-slate-100 text-slate-600 w-9 h-9 rounded-full flex items-center justify-center hover:bg-slate-200 transition-colors">&times;</button></div></div><div id="modal-student-list" class="overflow-y-auto p-2 md:p-5 flex-grow"></div></div></div>
    
    <div id="message-box" class="hidden fixed top-5 right-5 z-[100] p-4 rounded-lg shadow-md text-white"></div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbymOBZQmOLm1CqR0GeqbR-SfXXByABwTK2ZaWjKdtYDZFcHMpO76R_asWkP5sXzDEXdvw/exec";

        // DOM Elements
        const messageBox = document.getElementById('message-box');
        const navButtons = document.querySelectorAll('.nav-btn');
        const views = document.querySelectorAll('.view');
        const viewDescription = document.getElementById('current-view-description');
        const dashboardDatePicker = document.getElementById('dashboard-date-picker');
        const classDashboard = document.getElementById('class-dashboard');
        const alertsContainer = document.getElementById('active-alerts-container');
        const archivedAlertsContainer = document.getElementById('archived-alerts-container');
        const alertClassFilter = document.getElementById('alert-class-filter');
        const summaryDatePicker = document.getElementById('summary-date-picker');
        const fetchSummaryBtn = document.getElementById('fetch-summary-btn');
        const summaryContainer = document.getElementById('summary-container');
        const attendanceModal = document.getElementById('attendance-modal');
        const modalClassName = document.getElementById('modal-class-name');
        const modalStudentList = document.getElementById('modal-student-list');
        const modalCloseBtn = document.querySelector('.modal-close-btn');
        
        let currentClassId = null;
        let allAlertsData = [];

        // --- UI Helper Functions ---
        function createPieChart(percentage, size = 80) {
            const strokeWidth = 8;
            const radius = (size / 2) - (strokeWidth / 2);
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percentage / 100) * circumference;
            const color = percentage >= 95 ? 'text-green-500' : percentage >= 85 ? 'text-yellow-500' : 'text-red-500';

            return `
            <div class="relative w-[${size}px] h-[${size}px]">
                <svg class="w-full h-full" viewBox="0 0 ${size} ${size}">
                    <circle class="text-slate-200" stroke-width="${strokeWidth}" stroke="currentColor" fill="transparent" r="${radius}" cx="${size/2}" cy="${size/2}"></circle>
                    <circle class="${color}" stroke-width="${strokeWidth}" stroke-linecap="round" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"
                        stroke="currentColor" fill="transparent" r="${radius}" cx="${size/2}" cy="${size/2}" transform="rotate(-90 ${size/2} ${size/2})"></circle>
                </svg>
                <span class="absolute inset-0 flex items-center justify-center pie-chart-text ${color}">${percentage.toFixed(1)}%</span>
            </div>`;
        }

        // --- Core Functions ---
        function switchView(viewName) {
            views.forEach(v => v.classList.remove('active'));
            navButtons.forEach(b => {
                b.classList.remove('active', 'bg-white', 'text-indigo-600', 'shadow-md', 'font-semibold');
                b.classList.add('text-slate-600', 'hover:bg-slate-200');
            });
            const activeView = document.getElementById(`${viewName}-view`);
            const activeButton = document.querySelector(`.nav-btn[data-view="${viewName}"]`);
            activeView.classList.add('active');
            activeButton.classList.add('active', 'bg-white', 'text-indigo-600', 'shadow-md', 'font-semibold');
            activeButton.classList.remove('text-slate-600', 'hover:bg-slate-200');
            viewDescription.textContent = activeButton.dataset.desc;
            if (viewName === 'attendance') loadClassDashboard();
            else if (viewName === 'alerts') fetchAlerts();
            else if (viewName === 'summary' && summaryContainer.innerHTML.trim() !== '') fetchSummary();
        }

        function showMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.className = `fixed top-5 right-5 z-[100] p-4 rounded-lg shadow-md text-white ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        }

        // --- Papan Pemuka (Attendance Dashboard) ---
        async function loadClassDashboard() {
            const selectedDate = dashboardDatePicker.value;
            if (!selectedDate) return;
            classDashboard.innerHTML = `<div class="text-center p-12 text-slate-500">Menyemak status kelas...</div>`;
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getClassesWithStatus&date=${selectedDate}`);
                const result = await response.json();
                if (result.success) renderClassDashboard(result.data);
                else throw new Error(result.message);
            } catch (error) {
                showMessage(`Gagal memuatkan papan pemuka: ${error.message}`, true);
                classDashboard.innerHTML = '<p class="text-center text-red-500 p-12">Gagal memuatkan data.</p>';
            }
        }

        function renderClassDashboard(groupedClasses) {
            if (Object.keys(groupedClasses).length === 0) {
                classDashboard.innerHTML = '<p class="text-center text-slate-500 p-12">Tiada kelas ditemui.</p>';
                return;
            }
            const yearColors = {
                '1': 'bg-sky-50 border-sky-200', '2': 'bg-teal-50 border-teal-200',
                '3': 'bg-emerald-50 border-emerald-200', '4': 'bg-amber-50 border-amber-200',
                '5': 'bg-rose-50 border-rose-200', '6': 'bg-violet-50 border-violet-200',
                'Peralihan': 'bg-slate-50 border-slate-200', 'Kelas Khas': 'bg-indigo-50 border-indigo-200',
                'Lain-lain': 'bg-gray-50 border-gray-200'
            };
            const groupOrder = ['Peralihan', 'Tahun / Tingkatan 1', 'Tahun / Tingkatan 2', 'Tahun / Tingkatan 3', 'Tahun / Tingkatan 4', 'Tahun / Tingkatan 5', 'Tahun / Tingkatan 6', 'Kelas Khas', 'Lain-lain'];
            let dashboardHTML = '';
            groupOrder.forEach(groupName => {
                if (groupedClasses[groupName]) {
                    dashboardHTML += `<div class="mb-10"><h2 class="text-xl font-bold text-slate-800 border-b border-slate-200 pb-2 mb-6">${groupName}</h2><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-5">`;
                    groupedClasses[groupName].forEach(cls => {
                        const percentage = cls.totalStudents > 0 ? (cls.presentCount / cls.totalStudents) * 100 : 0;
                        const yearKey = groupName.includes('Tahun / Tingkatan') ? groupName.match(/\d+/)[0] : groupName;
                        const cardColor = yearColors[yearKey] || yearColors['Lain-lain'];
                        let contentHTML;
                        if (cls.hasRecord) {
                            contentHTML = `<div class="flex items-center gap-4">${createPieChart(percentage)}<div><h3 class="font-semibold text-slate-800 text-lg">${cls.className}</h3><p class="text-slate-600 font-bold text-xl">${cls.presentCount}/${cls.totalStudents} <span class="font-normal text-sm">Hadir</span></p><p class="text-slate-500 text-sm">${cls.teacherName || 'Tiada Guru'}</p></div></div>`;
                        } else {
                            contentHTML = `<div class="flex items-center justify-between"><div><h3 class="font-semibold text-slate-800 text-lg">${cls.className}</h3><p class="text-slate-500 text-sm">${cls.teacherName || 'Tiada Guru'}</p></div><div class="text-center"><div class="w-10 h-10 rounded-full flex justify-center items-center bg-yellow-100 text-yellow-600"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg></div><p class="text-xs text-yellow-600 mt-1">Belum Selesai</p></div></div>`;
                        }
                        dashboardHTML += `<button class="class-card-button ${cardColor} border rounded-lg p-4 text-left cursor-pointer transition-all duration-200 hover:-translate-y-1 hover:shadow-lg hover:border-indigo-500" data-class-id="${cls.classId}" data-class-name="${cls.className}">${contentHTML}</button>`;
                    });
                    dashboardHTML += `</div></div>`;
                }
            });
            classDashboard.innerHTML = dashboardHTML;
            document.querySelectorAll('.class-card-button').forEach(card => card.addEventListener('click', (e) => openAttendanceModal(e.currentTarget.dataset.classId, e.currentTarget.dataset.className)));
        }

        // --- Modal Kehadiran ---
        async function openAttendanceModal(classId, className) {
            currentClassId = classId;
            modalClassName.textContent = `Kehadiran: ${className}`;
            modalStudentList.innerHTML = `<div class="text-center p-12 text-slate-500">Memuatkan senarai murid...</div>`;
            attendanceModal.classList.remove('hidden');
            const selectedDate = dashboardDatePicker.value;
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getStudentsWithAttendance&classId=${classId}&date=${selectedDate}`);
                const result = await response.json();
                if (result.success) {
                    renderStudentTableInModal(result.data);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showMessage(`Gagal memuatkan murid: ${error.message}`, true);
                modalStudentList.innerHTML = '<p class="text-center text-red-500 p-12">Gagal memuatkan data.</p>';
            }
        }

        function renderStudentTableInModal(data) {
            const { students, attendanceRecords } = data;
            if (students.length === 0) {
                modalStudentList.innerHTML = '<p class="text-center text-slate-500 p-12">Tiada murid ditemui dalam kelas ini.</p>';
                return;
            }
            const attendanceMap = new Map(attendanceRecords.map(rec => [rec.studentId, rec]));
            let tableHTML = `<p class="text-center text-sm text-slate-500 italic mb-4">Tandakan hanya murid yang tidak hadir, lewat, atau bersebab. Kemaskini jika perlu.</p><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-slate-50 text-slate-600 uppercase"><tr><th class="p-3 w-12"><input type="checkbox" id="check-all" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"></th><th class="p-3">Nama Murid</th><th class="p-3">Status</th><th class="p-3">Catatan</th></tr></thead><tbody class="divide-y divide-slate-200">`;
            students.forEach(student => {
                const record = attendanceMap.get(student.studentId);
                const isChecked = !!record;
                const isDisabled = !isChecked;
                const status = record ? record.status : 'Absent';
                const remarks = record ? record.remarks : '';
                tableHTML += `<tr data-studentid="${student.studentId}" class="hover:bg-slate-50"><td class="p-3"><input type="checkbox" class="student-checkbox h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${isChecked ? 'checked' : ''}></td><td class="p-3 font-medium text-slate-800">${student.studentName}</td><td class="p-3"><select class="status-select w-full p-2 border border-slate-300 rounded-lg ${isDisabled ? 'bg-slate-100' : 'bg-white'}" ${isDisabled ? 'disabled' : ''}><option value="Absent" ${status === 'Absent' ? 'selected' : ''}>Tidak Hadir</option><option value="Late" ${status === 'Late' ? 'selected' : ''}>Lewat</option><option value="Excused" ${status === 'Excused' ? 'selected' : ''}>Bersebab</option></select></td><td class="p-3"><input type="text" class="remarks-input w-full p-2 border border-slate-300 rounded-lg ${isDisabled ? 'bg-slate-100' : 'bg-white'}" placeholder="Cth: Demam" value="${remarks}" ${isDisabled ? 'disabled' : ''}></td></tr>`;
            });
            tableHTML += `</tbody></table></div>`;
            modalStudentList.innerHTML = tableHTML;
            document.querySelectorAll('.student-checkbox').forEach(cb => cb.addEventListener('change', (e) => { const row = e.target.closest('tr'); const isChecked = e.target.checked; row.querySelectorAll('select, input[type="text"]').forEach(el => { el.disabled = !isChecked; el.classList.toggle('bg-slate-100', !isChecked); el.classList.toggle('bg-white', isChecked); }); }));
            document.getElementById('check-all').addEventListener('change', (e) => { document.querySelectorAll('.student-checkbox').forEach(cb => { if (cb.checked !== e.target.checked) { cb.checked = e.target.checked; cb.dispatchEvent(new Event('change')); } }); });
            document.getElementById('attendance-form').addEventListener('submit', submitAttendance);
        }

        async function submitAttendance(event) {
            event.preventDefault();
            const submitBtn = document.querySelector('#submit-btn-placeholder');
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<span>Mengemaskini...</span>`;
            const attendanceData = Array.from(document.querySelectorAll('#modal-student-list tbody tr')).filter(row => row.querySelector('.student-checkbox').checked).map(row => ({ studentId: row.dataset.studentid, status: row.querySelector('.status-select').value, remarks: row.querySelector('.remarks-input').value }));
            const payload = { date: dashboardDatePicker.value, classId: currentClassId, attendance: attendanceData };
            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', redirect: 'follow', body: JSON.stringify({ action: 'submitAttendance', payload }), headers: { 'Content-Type': 'text/plain;charset=utf-8' } });
                showMessage("Rekod kehadiran telah berjaya dikemaskini.", false);
                attendanceModal.classList.add('hidden');
                setTimeout(loadClassDashboard, 500); // Delay to allow backend to process
            } catch (error) {
                showMessage(`Gagal menghantar data: Terdapat isu rangkaian.`, true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg><span>Hantar Rekod</span>`;
            }
        }
        
        // --- Rumusan (Summary) ---
        async function fetchSummary() {
            const date = summaryDatePicker.value;
            if (!date) { showMessage("Sila pilih tarikh untuk memaparkan rumusan.", true); return; }
            summaryContainer.innerHTML = `<div class="text-center p-12 text-slate-500">Menganalisis data kehadiran...</div>`;
            try {
                const res = await fetch(`${SCRIPT_URL}?action=getSummary&date=${date}`);
                const result = await res.json();
                if (result.success) renderSummary(result.data);
                else throw new Error(result.message);
            } catch (e) {
                showMessage(`Gagal memuatkan rumusan: ${e.message}`, true);
                summaryContainer.innerHTML = '<p class="text-center text-red-500 p-12">Gagal memuatkan data rumusan.</p>';
            }
        }

        function renderSummary(data) {
            const { overall, byClass } = data;
            if (!overall || byClass.length === 0) {
                summaryContainer.innerHTML = '<p class="text-center text-slate-500 p-12 bg-slate-50 rounded-lg">Tiada data kehadiran lengkap ditemui untuk tarikh ini.</p>';
                return;
            }
            let html = `<div class="mb-12"><h2 class="text-xl font-bold text-slate-800 border-b border-slate-200 pb-2 mb-6">Rumusan Keseluruhan</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6"><div class="stat-card"><div class="value">${overall.totalStudents}</div><div class="label">Jumlah Murid</div></div><div class="stat-card"><div class="value text-green-600">${overall.totalPresent}</div><div class="label">Hadir</div></div><div class="stat-card"><div class="value text-red-600">${overall.totalAbsent}</div><div class="label">Tidak Hadir</div></div><div class="stat-card"><div class="value text-green-600">${overall.percentage}</div><div class="label">Peratus Hadir</div></div></div></div><div><h2 class="text-xl font-bold text-slate-800 border-b border-slate-200 pb-2 mb-6">Pecahan Mengikut Kelas (Selesai)</h2><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">`;
            byClass.forEach(cls => {
                html += `<div class="bg-white border border-slate-200 rounded-lg p-5"><h3 class="font-semibold text-lg mb-4">${cls.className}</h3><div class="grid grid-cols-2 gap-4 text-center mb-4"><div><div class="text-2xl font-bold">${cls.present}/${cls.totalStudents}</div><div class="text-sm text-slate-500">Hadir</div></div><div><div class="text-2xl font-bold text-red-600">${cls.absent}</div><div class="text-sm text-slate-500">Tidak Hadir</div></div></div><div class="bg-slate-50 text-center rounded-md p-3"><div class="text-2xl font-bold text-green-600">${cls.percentage}</div><div class="text-sm text-slate-500">Peratus Hadir</div></div></div>`;
            });
            html += `</div></div>`;
            html = `<style>.stat-card { background-color: #f8fafc; border-radius: 0.75rem; padding: 1.25rem; text-align: center; border: 1px solid #e2e8f0; } .stat-card .value { font-size: 2.25rem; font-weight: 700; line-height: 1; } .stat-card .label { font-size: 0.875rem; color: #64748b; margin-top: 0.5rem; }</style>` + html;
            summaryContainer.innerHTML = html;
        }

        // --- Amaran (Alerts) ---
        async function fetchAlerts() { alertsContainer.innerHTML = `<div class="text-center p-12 text-slate-500">Memuatkan amaran...</div>`; archivedAlertsContainer.innerHTML = ''; try { const [alertsRes, classesRes] = await Promise.all([fetch(`${SCRIPT_URL}?action=getAlerts`), fetch(`${SCRIPT_URL}?action=getClasses`)]); const alertsResult = await alertsRes.json(); const classesResult = await classesRes.json(); if (alertsResult.success) { allAlertsData = alertsResult.data; renderAlerts(); } else { throw new Error(alertsResult.message); } if (classesResult.success) { populateClassFilter(classesResult.data); } else { throw new Error(classesResult.message); } } catch (e) { showMessage(`Gagal memuatkan amaran: ${e.message}`, true); alertsContainer.innerHTML = '<p class="text-center text-red-500 p-12">Gagal memuatkan data amaran.</p>'; } };
        function populateClassFilter(classes) { if (alertClassFilter.options.length > 1) return; classes.sort((a, b) => a.className.localeCompare(b.className)); classes.forEach(cls => { const option = document.createElement('option'); option.value = cls.classId; option.textContent = cls.className; alertClassFilter.appendChild(option); }); };
        function renderAlerts() { const filterValue = alertClassFilter.value; const filteredAlerts = filterValue === 'all' ? allAlertsData : allAlertsData.filter(alert => alert.classId === filterValue); const activeAlerts = filteredAlerts.filter(a => !a.isArchived); const archivedAlerts = filteredAlerts.filter(a => a.isArchived); alertsContainer.innerHTML = activeAlerts.length > 0 ? activeAlerts.map(alert => createAlertCardHTML(alert)).join('') : '<div class="bg-green-50 border border-green-200 text-green-700 p-4 rounded-lg">Tiada amaran aktif ditemui.</div>'; archivedAlertsContainer.innerHTML = archivedAlerts.length > 0 ? `<h2 class="text-xl font-bold text-slate-600 border-b border-slate-200 pb-2 mb-6">Amaran Diarkib</h2><div class="space-y-4">${archivedAlerts.map(alert => createAlertCardHTML(alert)).join('')}</div>` : ''; addAlertCardListeners(); };
        function createAlertCardHTML(alert) { const formattedDate = new Date(alert.absenceDate).toLocaleDateString('ms-MY', { day: 'numeric', month: 'long', year: 'numeric' }); const absentDatesHTML = alert.absentDates.map(d => `<li class="bg-white border border-slate-200 px-2 py-1 rounded-md text-sm">${new Date(d).toLocaleDateString('ms-MY')}</li>`).join(''); return `<div class="alert-card bg-white border border-slate-200 rounded-lg ${alert.isArchived ? 'opacity-70' : ''} border-l-4 ${alert.isArchived ? 'border-slate-400' : 'border-yellow-500'}" data-studentid="${alert.studentId}" data-absencedate="${alert.absenceDate}"><div class="alert-header p-4 cursor-pointer flex justify-between items-center"><div><h3 class="font-semibold text-lg text-slate-900">${alert.studentName}</h3><small class="text-slate-500">${alert.warningType} (${alert.consecutiveDays} hari) - Dikeluarkan pada ${formattedDate}</small></div><span class="text-xs font-bold px-3 py-1 rounded-full ${alert.isArchived ? 'bg-slate-200 text-slate-600' : 'bg-yellow-100 text-yellow-800'}">${alert.isArchived ? 'Diarkib' : 'Aktif'}</span></div><div class="alert-body hidden border-t border-slate-200 p-4"><div class="bg-slate-50 rounded-lg p-3 mb-4"><p class="font-medium text-sm mb-2">Tarikh Tidak Hadir Berturut-turut:</p><ul class="flex flex-wrap gap-2">${absentDatesHTML}</ul></div><label class="block text-sm font-medium text-slate-700 mb-2">Catatan Tindakan:</label><textarea class="action-notes w-full p-2 border border-slate-300 rounded-lg" ${alert.isArchived ? 'disabled' : ''}>${alert.actionNotes || ''}</textarea><div class="flex gap-3 mt-4"><button class="btn-save-action bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors" ${alert.isArchived ? 'disabled' : ''}>Simpan Tindakan</button><button class="btn-archive-action bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors" ${alert.isArchived ? 'disabled' : ''}>Arkib</button></div></div></div>`; };
        function addAlertCardListeners() { document.querySelectorAll('.alert-header').forEach(header => header.addEventListener('click', () => header.nextElementSibling.classList.toggle('hidden'))); document.querySelectorAll('.btn-save-action').forEach(btn => btn.addEventListener('click', handleSaveAction)); document.querySelectorAll('.btn-archive-action').forEach(btn => btn.addEventListener('click', handleArchiveAction)); };
        async function handleAction(e, actionType) { const btn = e.target; const card = btn.closest('.alert-card'); const originalText = btn.textContent; const payload = { studentId: card.dataset.studentid, absenceDate: card.dataset.absencedate, ...(actionType === 'saveAction' && { warningType: card.querySelector('small').textContent.split(' (')[0], notes: card.querySelector('.action-notes').value }) }; btn.textContent = actionType === 'saveAction' ? "Menyimpan..." : "Mengarkib..."; btn.disabled = true; try { await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: actionType, payload }), headers: { 'Content-Type': 'text/plain;charset=utf-8' } }); showMessage(`Tindakan berjaya: ${actionType === 'saveAction' ? 'disimpan' : 'diarkib'}.`, false); setTimeout(fetchAlerts, 1000); } catch (err) { showMessage(`Gagal ${actionType === 'saveAction' ? 'menyimpan' : 'mengarkib'} tindakan.`, true); btn.textContent = originalText; btn.disabled = false; } };
        const handleSaveAction = (e) => handleAction(e, 'saveAction');
        const handleArchiveAction = (e) => handleAction(e, 'archiveAction');

        // --- Initialization ---
        function initializeApp() {
            const today = new Date();
            today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
            const todayISO = today.toISOString().split('T')[0];
            dashboardDatePicker.value = todayISO;
            summaryDatePicker.value = todayISO;
            switchView('attendance');
            navButtons.forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));
            dashboardDatePicker.addEventListener('change', loadClassDashboard);
            fetchSummaryBtn.addEventListener('click', fetchSummary);
            alertClassFilter.addEventListener('change', renderAlerts);
            modalCloseBtn.addEventListener('click', () => attendanceModal.classList.add('hidden'));
            attendanceModal.addEventListener('click', (e) => { if (e.target === attendanceModal) { attendanceModal.classList.add('hidden'); } });
        }
        
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
